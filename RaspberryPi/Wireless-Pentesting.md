# Wireless Pentesting with a Raspberry Pi 4 and Kali Linux
## Requirements
- **Required:**
  - Raspberry Pi 4 (2GB, 4GB or 8GB)
  - Micro SD card (Minimal 16GB, preferably 32GB+)
  - [Raspberry Pi Imager software](https://www.raspberrypi.com/software/) (You can also download Kali Linux for Raspberry Pi manually and install it to a micro SD card, but I prefer to use the imager software provided by Raspberry Pi, as it already includes the latest Kali Linux images.)
  - Ethernet cable with internet connection (We will use the built-in WiFi for setting up an access point, so we need another network interface to connect to the internet and install packages.)
- **Optional:**
  - Monitor with micro HDMI connection (Only needed for local setup)
  - USB keyboard and mouse (Only needed for local setup)
  - USB WiFi adapter (Preferably one that is supported with Linux in-kernel drivers, please visit this amazing [GitHub repo from morrownr](https://github.com/morrownr/USB-WiFi/blob/main/home/USB_WiFi_Adapters_that_are_supported_with_Linux_in-kernel_drivers.md) for more in-depth knowledge on USB WiFi adapters and their chipsets. I like to use my ALFA AWUS036ACM.)

## Initial setup
Use the Raspberry Pi Imager tool to flash Kali Linux (preferably 32-bit, as it gets more testing) to the micro SD card.
Insert the SD card into the Raspberry Pi, as any other software installation on the Pi, and connect it to a power source and let it boot for 1-2 minutes.

> Be aware that the default Kali Linux image for Raspberry Pi has SSH enabled and uses the default kali:kali credentials.

Now you have two options: Use SSH to connect to the freshly installed Pi, or connect both a monitor and keyboard and mouse to it and do the configuration locally.
I prefer to use SSH to do the configuration, as everything can be done through a command line.

As a best practice, I recommend changing the password of the default kali user right away.
```
$ passwd
```

Now let's start by updating the system with the newest packages.
```
$ sudo apt update
$ sudo apt full-upgrade -y
```

I recommend to install these Kali Linux Metapackages ([list of metapackages](https://www.kali.org/docs/general-use/metapackages/)):
> Most of them are already installed by default, but I like to ensure that this is the case be explicitly invoking an installation.
```
$ sudo apt install -y kali-linux-core kali-linux-default kali-linux-arm kali-linux-headless
```
I do not recommend to install any other Metapackages as long as you don't need them, just to save some space on our (maybe limited in space) micro SD card.

To make bluetooth work properly, you need to enable and start two services.
```
$ sudo systemctl enable --now hciuart.service
$ sudo systemctl enable --now bluetooth.service
```

## Access point setup
We start by installing the necessary packages.
```
$ sudo apt install -y hostapd dnsmasq
```

Now let's configure our wireless network interface with a static ip address. This will be the ip address of our access point we will create.
We need to edit the network configuration file and add some lines to configure our wireless network interface, wlan0 in my case.
> Feel free to use a text editor of your choice :)
```
$ sudo nano /etc/network/interfaces
```
My configuration file looks like this:
```
source-directory /etc/network/interfaces.d

auto lo
  iface lo inet static

allow-hotplug wlan0
iface wlan0 inet static
  address 192.168.0.1
  netmask 255.255.255.0
  network 192.168.0.0
  broadcast 192.168.0.255
```

There's no need to restart any services at this point. We first configure hostapd and dnsmasq too and restart our system when everything is set up to verify the working our configuration.

Let's start configuring dnsmasq to function as DHCP server on our wireless network interface. Clients will later connect to it and have to receive a valid ip configuration.
We first move the original configuration out of the way and create one for ourselves.
```
$ sudo mv /etc/dnsmasq.conf /etc/dnsmasq.conf.orig
$ sudo nano /etc/dnsmasq.conf
```
My configuration file looks like this:
> As I already mentioned, we just need a DHCP server for our setup to function properly. These two lines is all we need to achieve this. Easy, isn't it? :)
```
interface=wlan0
dhcp-range=192.168.0.2,192.168.0.5,24h
```
> I choose to only include a small range (192.168.0.2 to 192.168.0.5) of ip addresses in my DHCP range with a lease period of 24 hours. Of course you can use whatever you prefer. The same goes for the configuration of the wireless network interface itself.

Now we will configure hostapd to transform our wireless network interface to an access point. hostapd doesn't come with an existing configuration file, so we have to create one ourselves.
```
$ sudo nano /etc/hostapd/hostapd.conf
```
My configuration file looks like this:
```
interface=wlan0
hw_mode=g
channel=1
ieee80211d=1
country_code=BE
ieee80211n=1
wmm_enabled=1
ignore_broadcast_ssid=0
auth_algs=1
wpa=2
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP
wpa_passphrase=<password>
ssid=<ssid>
```
> Please change the channel, country_code, wpa_passphrase and ssid settings to your own. I exerimented with 'channel=0', which stand for automatically determining the channel based on the environment (other wireless signals going through the air), but found it to be less reliable and makes the hostapd service unable to start.

> ignore_broadcast_ssid is set to 0. Setting this to 1 will hide your access point by disabling the ssid broadcast.

To tell the hostapd service to use our newly created configuration file, we need to edit one line in its configuration file.
```
$ sudo nano /etc/default/hostapd
```
Uncomment and edit the following line in the configuration file:
```
DAEMON_CONF="/etc/hostapd/hostapd.conf"
```

Lastly we need to enable and start both hostapd and dnsmasq services.
> I had to unmask the hostapd service before being able to start it.
```
$ sudo systemctl unmask hostapd.service
$ sudo systemctl enable --now hostapd.service
$ sudo systemctl enable --now dnsmasq.service
```

Now it's time to reboot the Raspberry Pi.
```
$ sudo reboot now
```

If everything is configured correctly, you should see a wireless network popping up with your specified ssid. Try to connect to it and SSH into your Raspberry Pi using the ip address of the access point. This should be successfull before proceeding with the next configuration steps.

## VNC setup
If the previous configuration worked, you can continue by setting up a VNC server on your Raspberry Pi.
>The following steps are mandatory for you to start using Kali Linux on your Raspberry Pi. If the command line is all you need, you can skip this step and start pentesting.

>In case you want to use tools like Wireshark on your Raspberry Pi, it might be useful to follow this part about configuring VNC. Especially if you want to use your iPad for example as VNC client and use it in combination with your Raspberry Pi as a mobile pentesting setup.

By default TightVNC is installed on Kali Linux. I experimented with it, but found it lacked some features and therefor switched to TigerVNC.
Let's start by removing the TightVNC packages from our system and install TigerVNC instead.
```
$ sudo apt purge -y tightvncserver tightvncpasswd xtightvncviewer
$ sudo apt install -y tigervnc-standalone-server tigervnc-xorg-extension
$ sudo apt autoremove
```

Now start by setting a password for your VNC connections. I recommend using a strong password, just like you did when changing the password of the kali user.
```
$ vncpasswd
```

I prefer to create a bash script to start our VNC server for us, instead of having to type the whole command.
```
$ nano /home/kali/.vnc/vnc.sh
```
My script looks like this:
> Feel free to change these parameter values to fullfil your own needs. Just leave -localhost to no. Otherwise only connections from the localhost are allowed.
```
#!/usr/bin/zsh
tigervncserver -display :1 -useold -desktop kali-pi -rfbport 5901 -geometry 1100x700 -depth 32 -localhost no
```
Don't forget to make this script executable.
```
$ chmod +x /home/kali/.vnc/vnc.sh
```
Now run the script and verify that your VNC server is running.
> ss -lt lists all listening TCP sockets. You should see one listening on 0.0.0.0:5901.
```
$ /home/kali/.vnc/vnc.sh
$ ss -lt
```

If the VNC server works and you are able to connect to it through any VNC client of your choice, we can proceed to the next step.

In this step we will create a cronjob for our kali user to run our VNC server when the Raspberry Pi boots up. This allows us to directly connect to it after booting, without the need of using SSH first to start the VNC server.
```
$ crontab -e
```
Add the following lines at the end of the file:
> It's important to set the 'SHELL' environment variable in the cronjob. Otherwise the default command line will be sh instead of zsh, resulting in different behavious when using the terminal through VNC.
```
SHELL=/usr/bin/zsh
@reboot . $HOME/.profile; /home/kali/.vnc/vnc.sh
```

Now we reboot our Raspberry Pi again.
```
$ sudo reboot now
```

Both the access point and VNC server should be running automatically when booted. Verify this by connecting to the access point and using a VNC client to connect over port 5901 to the ip address of the access point. If this works, well done! :)

## Conclusion
Congratulations! You now have a working mobile pentesting setup!
I like to use it in combination with a USB wireless adapter and a powerbank. It's perfect for wireless pentesting and even features a graphical interface when you need to run tools that don't feature a command line version.
Connect your laptop, phone, iPad, etc. to it and experience the fun of a self made mobile pentesting setup!

## Possible future features
- Firewall (ufw) implementation
- Extra wireless network interface for internet access, bridged to access point
  - wlan0: Access point
  - wlan1: Pentesting
  - wlan2: Internet access, bridged to wlan0
- Extended storage over USB to overcome small or unreliable micro SD cards
